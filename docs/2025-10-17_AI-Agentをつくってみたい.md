# AI Agent Implementation Plan

## ç¾çŠ¶ã®èª²é¡Œ

ç¾åœ¨ã®å®Ÿè£…ã¯ã€Œå˜ç™ºã®LLMå‘¼ã³å‡ºã—ã€ã§ã€AI Agentã¨ã¯ç¨‹é ã„:

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼è³ªå•
  â†“
ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆClaude APIå‘¼ã³å‡ºã—1å›ç›®ï¼‰
  â†“
Discordæ¤œç´¢ï¼ˆ1å›ã ã‘ï¼‰
  â†“
å›ç­”ç”Ÿæˆï¼ˆClaude APIå‘¼ã³å‡ºã—2å›ç›®ï¼‰
  â†“
çµ‚äº†
```

èª²é¡Œ:
- æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¦ã‚‚è¿½åŠ ã§èª¿æŸ»ã—ãªã„
- æ¤œç´¢çµæœãŒæœŸå¾…ã¨é•ã£ã¦ã‚‚å†è©¦è¡Œã—ãªã„
- è¤‡é›‘ãªè³ªå•ã‚’åˆ†è§£ã—ã¦æ®µéšçš„ã«è§£æ±ºã§ããªã„
- è‡ªå¾‹çš„ãªåˆ¤æ–­ãŒã§ããªã„

## ç›®æŒ‡ã™å§¿: Agentic Loop

Claude Codeã‚„Gemini CLIã®ã‚ˆã†ã«ã€è‡ªå¾‹çš„ã«æƒ…å ±ã‚’é›†ã‚ã¦å›ç­”ã™ã‚‹ãƒœãƒƒãƒˆ:

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼è³ªå•
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ€è€ƒ: ä½•ã®æƒ…å ±ãŒå¿…è¦?         â”‚
â”‚ åˆ¤æ–­: ã©ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†?       â”‚ â† ClaudeãŒè‡ªå¾‹åˆ¤æ–­
â”‚ å®Ÿè¡Œ: ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—          â”‚
â”‚ è¦³å¯Ÿ: çµæœã‚’ç¢ºèª             â”‚
â”‚ ç¶™ç¶š: ã¾ã è¶³ã‚Šãªã„?          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ ååˆ†ãªæƒ…å ±ãŒé›†ã¾ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
âœ… å›ç­”ç”Ÿæˆ
```

## å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®æ¤œè¨

### é¸æŠè‚¢ã®æ¦‚è¦

Agentã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã€ä»¥ä¸‹ã®é¸æŠè‚¢ãŒã‚ã‚‹:

1. **æ—¢å­˜CLIãƒ„ãƒ¼ãƒ«ã‚’åŒ…ã‚€** (Claude Code CLI / Gemini CLI)
2. **å…¬å¼Agent SDKã‚’ä½¿ã†** (Anthropic Claude Agent SDK)
3. **è‡ªå‰ã§Agentãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè£…** (Anthropic API + ç‹¬è‡ªå®Ÿè£…)

### âŒ é¸æŠè‚¢1: æ—¢å­˜CLIãƒ„ãƒ¼ãƒ«ã‚’åŒ…ã‚€

ã€ŒClaude Codeã‚„Gemini CLIã‚’å‹•ã‹ã—ã¦ã€ãã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã«Discordã‚’ã‹ã¶ã›ã‚‹ã€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:

**Claude Codeã®å ´åˆ:**
- VSCodeæ‹¡å¼µæ©Ÿèƒ½ã¨ã—ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- CLIãƒ¢ãƒ¼ãƒ‰ã‚‚å­˜åœ¨ã™ã‚‹ãŒã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªå¯¾è©±å‹ã§è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- Discordç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ã‚’æ³¨å…¥ã™ã‚‹ä»•çµ„ã¿ãŒãªã„
- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§è¤‡æ•°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸¦åˆ—å‡¦ç†ã™ã‚‹ç”¨é€”ã«ã¯ä¸å‘ã

**Gemini CLIã®å ´åˆ:**
```ruby
# ç†è«–ä¸Šã¯å¯èƒ½ã ãŒ...
response = `gemini chat "#{user_message}"`
```

å•é¡Œç‚¹:
- ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰(æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ—ãƒ­ã‚»ã‚¹ç”Ÿæˆ)
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ä¸å¯(æ¯å›ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚»ãƒƒãƒˆ)
- Discordå°‚ç”¨ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ ã§ããªã„
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å›°é›£
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯(ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³)
- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªCLIãƒ„ãƒ¼ãƒ«ã‚’ãƒãƒƒãƒå‡¦ç†çš„ã«ä½¿ã†ã®ã¯æœ¬æ¥ã®ç”¨é€”ã¨ç•°ãªã‚‹

### ğŸ¤” é¸æŠè‚¢2: å…¬å¼Agent SDKã‚’ä½¿ã†

AnthropicãŒPythonã¨TypeScriptå‘ã‘ã«æä¾›ã—ã¦ã„ã‚‹ **Claude Agent SDK** ã‚’ä½¿ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:

- GitHub: [claude-agent-sdk-python](https://github.com/anthropics/claude-agent-sdk-python)
- GitHub: [claude-agent-sdk-typescript](https://github.com/anthropics/claude-agent-sdk-typescript)
- å…¬å¼ãƒ–ãƒ­ã‚°: [Building agents with the Claude Agent SDK](https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk)

**ä¸»ãªæ©Ÿèƒ½:**
- `ClaudeSDKClient`: Claude Codeã¨ã®åŒæ–¹å‘ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªä¼šè©±
- ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«: Pythonã®é–¢æ•°ã¨ã—ã¦ãƒ„ãƒ¼ãƒ«ã‚’å®šç¾©å¯èƒ½(in-process MCP servers)
- ãƒ•ãƒƒã‚¯æ©Ÿèƒ½: Agent loopã®ç‰¹å®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‡¦ç†ã‚’æŒŸã‚ã‚‹
- Claude Codeã®æ—¢å­˜Agentæ©Ÿèƒ½ã‚’ãƒ©ãƒƒãƒ—

**ãƒ¡ãƒªãƒƒãƒˆ:**
- å…¬å¼ã‚µãƒãƒ¼ãƒˆã€ãƒã‚°ä¿®æ­£ã‚„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒæœŸå¾…ã§ãã‚‹
- Agent loopã®å®Ÿè£…ãŒä¸è¦(Claude Codeã®æ©Ÿèƒ½ã‚’åˆ©ç”¨)
- in-process MCP serverã§ãƒ„ãƒ¼ãƒ«ã‚’Python/TSã§ç›´æ¥å®šç¾©
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå……å®Ÿ

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- **è¨€èªã®åˆ¶ç´„**: Python ã¾ãŸã¯ TypeScript ã®ã¿(Rubyã‚µãƒãƒ¼ãƒˆãªã—)
- **Claude Codeã¸ã®ä¾å­˜**: Claude Codeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨å®Ÿè¡Œç’°å¢ƒãŒå¿…è¦
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¤‡é›‘åŒ–**: Rails(Ruby) â†’ Python/Node.js â†’ Claude Code ã®å¤šå±¤æ§‹é€ 
- **ãƒ‡ãƒ—ãƒ­ã‚¤ã®è¤‡é›‘åŒ–**: Railsã‚¢ãƒ—ãƒªã«åŠ ãˆã¦Python/Node.jsç’°å¢ƒã®ç®¡ç†
- **ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰**: Claude Codeãƒ—ãƒ­ã‚»ã‚¹ã‚’èµ·å‹•ãƒ»ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®åˆ¶ç´„**: Claude Codeã®æ çµ„ã¿ã®ä¸­ã§ã®å®Ÿè£…ã«ãªã‚‹

**Railsçµ±åˆã®å ´åˆ:**
```ruby
# Railsã‹ã‚‰Python SDKã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹
class DiscordAgentResponseJob < ApplicationJob
  def perform(message)
    # æ–¹æ³•1: Python subprocessã‚’èµ·å‹•
    result = `python3 agent_script.py "#{message}"`

    # æ–¹æ³•2: gRPC/HTTPã§Pythonã‚µãƒ¼ãƒ“ã‚¹ã¨é€šä¿¡
    response = AgentService.call(message)
  end
end
```

**åˆ¤æ–­:**
- Railsãƒã‚¤ãƒ†ã‚£ãƒ–ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§Python/TypeScriptã‚’å°å…¥ã™ã‚‹ã®ã¯ã€ä¿å®ˆæ€§ã®è¦³ç‚¹ã‹ã‚‰æ…é‡ã«æ¤œè¨ã™ã¹ã
- å°è¦æ¨¡ãƒãƒ¼ãƒ ã‚„å­¦ç¿’ç›®çš„ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ä¾å­˜é–¢ä¿‚ã‚’å¢—ã‚„ã™ã‚ˆã‚Šè‡ªå‰å®Ÿè£…ã®æ–¹ãŒç†è§£ã—ã‚„ã™ã„
- ãŸã ã—ã€å¤§è¦æ¨¡ã§è¤‡é›‘ãªAgentæ©Ÿèƒ½ãŒå¿…è¦ãªå ´åˆã¯æ¤œè¨ã®ä¾¡å€¤ã‚ã‚Š

### â­ï¸ é¸æŠè‚¢3: è‡ªå‰ã§Agentãƒ«ãƒ¼ãƒ—å®Ÿè£…(æ¨å¥¨)

Claude Codeã‚„Gemini CLIã¨**åŒã˜æŠ€è¡“**ã‚’ä½¿ã£ã¦è‡ªä½œ:

| è¦ç´  | Claude Code | è‡ªä½œå®Ÿè£… | çŠ¶æ³ |
|-----|------------|---------|------|
| LLM | Claude Sonnet 4.5 | Claude Sonnet 4.5 | âœ… åŒã˜ |
| API | Anthropic Tool Use | Anthropic Tool Use | âœ… åŒã˜ |
| ãƒ„ãƒ¼ãƒ« | ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œç­‰ | Discordæ“ä½œ | âœ… ã‚ˆã‚Šé©åˆ‡ |
| Agentãƒ«ãƒ¼ãƒ— | VSCodeæ‹¡å¼µå†… | Rubyå®Ÿè£… | ğŸ”¨ å®Ÿè£…å¿…è¦ |
| çµ±åˆ | VSCode | Rails | âœ… ãƒã‚¤ãƒ†ã‚£ãƒ– |

**çµè«–**: Claude Codeã¯ã€ŒAnthropic APIã®å‚è€ƒå®Ÿè£…ã€ã«éããªã„ã€‚åŒã˜APIã‚’ä½¿ãˆã°åŒç­‰ã®çŸ¥èƒ½ãŒå¾—ã‚‰ã‚Œã‚‹ã€‚

## å®Ÿè£…æ–¹é‡

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
Discord Message
  â†“
DiscordAgentResponseJob (Rails ActiveJob)
  â†“
Llm::AgentLoop (Agentãƒ«ãƒ¼ãƒ—ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼)
  â†“
Llm::Claude (Anthropic SDK wrapper, ãƒ„ãƒ¼ãƒ«å¯¾å¿œç‰ˆ)
  â†“
Discord::Tools::* (å„ç¨®ãƒ„ãƒ¼ãƒ«å®Ÿè£…)
  â”œâ”€ SearchMessages (Discordæ¤œç´¢)
  â”œâ”€ GetChannelInfo (ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±)
  â”œâ”€ GetThreadContext (ã‚¹ãƒ¬ãƒƒãƒ‰å±¥æ­´)
  â”œâ”€ SearchWeb (å¤–éƒ¨æ¤œç´¢)
  â””â”€ AnalyzeReactions (ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ†æ)
```

### ã‚³ã‚¢å®Ÿè£…: Agentãƒ«ãƒ¼ãƒ—

```ruby
# app/services/llm/agent_loop.rb
module Llm
  class AgentLoop
    MAX_ITERATIONS = 10
    MAX_TOKENS_BUDGET = 50_000

    attr_reader :iterations, :total_tokens

    def initialize(claude_client)
      @claude = claude_client
      @tools = load_tools
      @iterations = 0
      @total_tokens = 0
    end

    def run(user_message:, system_prompt:)
      messages = [{ role: "user", content: user_message }]

      loop do
        @iterations += 1
        break if @iterations > MAX_ITERATIONS
        break if @total_tokens > MAX_TOKENS_BUDGET

        # Claude APIã‚’ãƒ„ãƒ¼ãƒ«å®šç¾©ä»˜ãã§å‘¼ã³å‡ºã—
        response = @claude.messages_with_tools(
          messages: messages,
          system: system_prompt,
          tools: @tools.map(&:definition),
          max_tokens: 4096
        )

        @total_tokens += response.usage.total_tokens

        case response.stop_reason
        when "end_turn"
          # ClaudeãŒå®Œäº†ã¨åˆ¤æ–­
          return extract_final_answer(response)

        when "tool_use"
          # ClaudeãŒãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã„ãŸã„
          tool_results = execute_tools(response)

          # ä¼šè©±å±¥æ­´ã«è¿½åŠ 
          messages << { role: "assistant", content: response.content }
          messages << { role: "user", content: tool_results }

        when "max_tokens"
          # ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™ã€ç¶™ç¶š
          messages << { role: "assistant", content: response.content }
        end
      end

      "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å‡¦ç†ãŒè¤‡é›‘ã§å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"
    end

    private

    def load_tools
      [
        Discord::Tools::SearchMessages,
        Discord::Tools::GetChannelInfo,
        Discord::Tools::GetThreadContext,
        Discord::Tools::SearchWeb
      ]
    end

    def execute_tools(response)
      tool_uses = response.content.select { |block| block.type == "tool_use" }

      tool_uses.map do |tool_use|
        Rails.logger.info "ğŸ”§ Tool: #{tool_use.name}(#{tool_use.input})"

        tool_class = @tools.find { |t| t.definition[:name] == tool_use.name }
        result = tool_class.execute(tool_use.input)

        {
          type: "tool_result",
          tool_use_id: tool_use.id,
          content: result
        }
      rescue => e
        Rails.logger.error "Tool failed: #{e.message}"
        {
          type: "tool_result",
          tool_use_id: tool_use.id,
          content: "ã‚¨ãƒ©ãƒ¼: #{e.message}",
          is_error: true
        }
      end
    end

    def extract_final_answer(response)
      response.content
        .select { |block| block.type == "text" }
        .map(&:text)
        .join("\n")
    end
  end
end
```

### ãƒ„ãƒ¼ãƒ«å®šç¾©ä¾‹

```ruby
# app/services/discord/tools/search_messages.rb
module Discord
  module Tools
    class SearchMessages
      # Anthropic Tool Use APIå½¢å¼ã®å®šç¾©
      def self.definition
        {
          name: "search_discord_messages",
          description: "Discordã‚µãƒ¼ãƒãƒ¼å†…ã®éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢ã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€æ™‚é–“ç¯„å›²ã€ãƒãƒ£ãƒ³ãƒãƒ«ã§çµã‚Šè¾¼ã‚ã¾ã™ã€‚",
          input_schema: {
            type: "object",
            properties: {
              query: {
                type: "string",
                description: "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹: 'Rails', 'ã‚¨ãƒ©ãƒ¼'ï¼‰"
              },
              time_range: {
                type: "string",
                enum: ["1h", "1d", "1w", "1m"],
                description: "æ¤œç´¢ã™ã‚‹æ™‚é–“ç¯„å›²"
              },
              channel_id: {
                type: "string",
                description: "ç‰¹å®šã®ãƒãƒ£ãƒ³ãƒãƒ«ã«çµã‚Šè¾¼ã‚€ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
              },
              limit: {
                type: "integer",
                description: "æœ€å¤§å–å¾—ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10ï¼‰",
                default: 10
              }
            },
            required: ["query"]
          }
        }
      end

      # ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œ
      def self.execute(input)
        bot = Discord::Bot.new(
          Rails.application.credentials.dig(:discord_app, :bot_token)
        )

        results = bot.search_messages(
          query: input["query"],
          time_range: parse_time_range(input["time_range"]),
          channel_id: input["channel_id"],
          limit: input["limit"] || 10
        )

        format_results(results)
      end

      private

      def self.parse_time_range(range)
        case range
        when "1h" then 1.hour.ago
        when "1d" then 1.day.ago
        when "1w" then 1.week.ago
        when "1m" then 1.month.ago
        else 1.day.ago
        end
      end

      def self.format_results(results)
        results.map do |msg|
          {
            author: msg.dig("author", "username"),
            content: msg["content"],
            timestamp: msg["timestamp"],
            channel: msg["channel_name"],
            url: msg["url"]
          }
        end.to_json
      end
    end
  end
end
```

### Claude.rbã®æ‹¡å¼µ

```ruby
# app/services/llm/claude.rb ã«è¿½åŠ 
module Llm
  class Claude < Base
    # æ—¢å­˜ã®generateãƒ¡ã‚½ãƒƒãƒ‰ã¯ãã®ã¾ã¾ç¶­æŒ

    # ãƒ„ãƒ¼ãƒ«ä½¿ç”¨å¯¾å¿œç‰ˆã®æ–°ãƒ¡ã‚½ãƒƒãƒ‰
    def messages_with_tools(messages:, system:, tools:, max_tokens: 4096)
      params = {
        model: MODEL,
        messages: format_messages(messages),
        max_tokens: max_tokens,
        system: system
      }

      # ãƒ„ãƒ¼ãƒ«å®šç¾©ã‚’è¿½åŠ 
      params[:tools] = tools if tools.present?

      @client.messages.create(**params)
    rescue Faraday::Error => e
      Rails.logger.error("Claude API error: #{e.message}")
      raise StandardError, "Claude API request failed: #{e.message}"
    end

    private

    def format_messages(messages)
      messages.map do |msg|
        {
          role: msg[:role].to_s,
          content: msg[:content]
        }
      end
    end
  end
end
```

### Jobå®Ÿè£…

```ruby
# app/jobs/discord_agent_response_job.rb
class DiscordAgentResponseJob < ApplicationJob
  queue_as :default

  def perform(channel_id:, thread_id:, user_message:, user_name:)
    Rails.logger.info "ğŸ¤– Agent started: #{user_message}"

    # Agentãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
    llm = Llm::Claude.new
    agent = Llm::AgentLoop.new(llm)

    response = agent.run(
      user_message: user_message,
      system_prompt: build_system_prompt(user_name, channel_id)
    )

    # Discordè¿”ä¿¡
    send_to_discord(thread_id, response)

    Rails.logger.info "âœ… Agent completed (#{agent.iterations} iterations, #{agent.total_tokens} tokens)"
  rescue StandardError => e
    Rails.logger.error "âŒ Agent failed: #{e.message}"
    send_to_discord(thread_id, "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
    raise
  end

  private

  def build_system_prompt(user_name, channel_id)
    <<~PROMPT
      ã‚ãªãŸã¯Teacher Teacherã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£TTæ‘ã®ãƒ˜ãƒ«ãƒ—Agentã§ã™ã€‚

      #{user_name}ã•ã‚“ã‹ã‚‰ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚
      åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã€å¿…è¦ãªæƒ…å ±ã‚’è‡ªå¾‹çš„ã«åé›†ã—ã¦ãã ã•ã„ã€‚

      è¡Œå‹•æŒ‡é‡:
      - ä¸ç¢ºã‹ãªæƒ…å ±ã¯æ¨æ¸¬ã›ãšã€ãƒ„ãƒ¼ãƒ«ã§ç¢ºèªã™ã‚‹
      - è¤‡æ•°ã®æƒ…å ±æºã‚’ç¢ºèªã—ã¦ç·åˆçš„ã«åˆ¤æ–­ã™ã‚‹
      - æ¤œç´¢çµæœãŒä¸ååˆ†ãªã‚‰ã€æ¡ä»¶ã‚’å¤‰ãˆã¦å†æ¤œç´¢ã™ã‚‹
      - éå»ã®è­°è«–ã‚’å‚ç…§ã™ã‚‹éš›ã¯ã€èª°ãŒã„ã¤ç™ºè¨€ã—ãŸã‹æ˜è¨˜ã™ã‚‹
      - æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯ã€è¿½åŠ è³ªå•ã‚’ã™ã‚‹

      å›ç­”ã‚¹ã‚¿ã‚¤ãƒ«:
      - ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„æ—¥æœ¬èª
      - æ ¹æ‹ ã‚’ç¤ºã—ãªãŒã‚‰èª¬æ˜
      - å¿…è¦ã«å¿œã˜ã¦å…·ä½“ä¾‹ã‚’æŒ™ã’ã‚‹
    PROMPT
  end

  def send_to_discord(thread_id, message)
    bot = Discord::Bot.new(
      Rails.application.credentials.dig(:discord_app, :bot_token)
    )
    bot.send_message(
      channel_or_thread_id: thread_id,
      content: message
    )
  end
end
```

## å®Ÿè£…ã®åˆ©ç‚¹

### 1. ãƒ•ãƒ«ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
- Agentã®æŒ™å‹•ã‚’å®Œå…¨ã«åˆ¶å¾¡
- ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“
- ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒè‡ªç”±

### 2. Railsçµ±åˆ
- ActiveJobã§éåŒæœŸå®Ÿè¡Œ
- Redisã§ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°
- ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚„ãƒªãƒˆãƒ©ã‚¤ãŒæ¨™æº–æ©Ÿèƒ½ã§å¯èƒ½

### 3. Discordæœ€é©åŒ–
- Discordå°‚ç”¨ã®ãƒ„ãƒ¼ãƒ«ã‚’è‡ªç”±ã«è¿½åŠ 
- ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®æ–‡è„ˆã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆ
- TTæ‘ã®ç‰¹æ€§ã«åˆã‚ã›ãŸèª¿æ•´ãŒå¯èƒ½

### 4. ã‚³ã‚¹ãƒˆç®¡ç†
- ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¿½è·¡
- åå¾©å›æ•°ã®ä¸Šé™è¨­å®š
- å¿…è¦ã«å¿œã˜ã¦æœ€é©åŒ–

### 5. å­¦ç¿’æ©Ÿä¼š
- Agentå®Ÿè£…ã®æ·±ã„ç†è§£
- Anthropic APIã®æ´»ç”¨æ–¹æ³•ç¿’å¾—
- ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å“è³ªã®ã‚³ãƒ¼ãƒ‰è¨­è¨ˆ

## å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: åŸºç¤å®Ÿè£… (2-3æ—¥)
- [ ] `Llm::Claude#messages_with_tools` å®Ÿè£…
- [ ] `Llm::AgentLoop` å®Ÿè£…
- [ ] åŸºæœ¬ãƒ„ãƒ¼ãƒ«2-3å€‹å®Ÿè£…
  - [ ] `Discord::Tools::SearchMessages`
  - [ ] `Discord::Tools::GetThreadContext`
  - [ ] `Discord::Tools::GetChannelInfo`
- [ ] `DiscordAgentResponseJob` ã«ç½®ãæ›ãˆ
- [ ] åŸºæœ¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### Phase 2: ãƒ„ãƒ¼ãƒ«æ‹¡å…… (2-3æ—¥)
- [ ] Webæ¤œç´¢ãƒ„ãƒ¼ãƒ«è¿½åŠ 
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ãƒ„ãƒ¼ãƒ«
- [ ] ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ†æãƒ„ãƒ¼ãƒ«
- [ ] ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œçµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- [ ] ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºã®æ”¹å–„

### Phase 3: æœ€é©åŒ– (2-3æ—¥)
- [ ] ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†(è¦ç´„ãƒ»åˆˆã‚Šè¾¼ã¿)
- [ ] Prompt Cachingæ´»ç”¨
- [ ] Extended Thinking mode
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã¨æ”¹å–„
- [ ] ã‚³ã‚¹ãƒˆè¿½è·¡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

### Phase 4: é«˜åº¦ãªæ©Ÿèƒ½ (ç¶™ç¶šçš„)
- [ ] ã‚µãƒ–Agentã®ç”Ÿæˆ
- [ ] ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‹ã‚‰ã®å­¦ç¿’
- [ ] å¤–éƒ¨APIçµ±åˆ(Stack Overflowç­‰)
- [ ] ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œ(ç”»åƒè§£æ)

## æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œä¾‹

### ã‚±ãƒ¼ã‚¹1: è¤‡é›‘ãªè³ªå•

**ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ã€Œå…ˆé€±ã®Railsã®è­°è«–ã§èª°ãŒä½•ã‚’è¨€ã£ã¦ãŸ?ã€

**Agentã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹**:
```
1. ğŸ¤” ã€Œå…ˆé€±ã€ã€ŒRailsã€ã«é–¢ã™ã‚‹è­°è«–ã‚’æ¢ã™å¿…è¦ãŒã‚ã‚‹
2. ğŸ”§ search_discord_messages(query="Rails", time_range="1w")
3. ğŸ‘€ 5ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã£ãŸ
4. ğŸ¤” ç™ºè¨€è€…ã®æƒ…å ±ã‚‚æ¬²ã—ã„
5. ğŸ”§ get_user_activity(user_ids=["123", "456"])
6. ğŸ‘€ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—å®Œäº†
7. âœ… æƒ…å ±ãŒæƒã£ãŸã€å›ç­”ã‚’ç”Ÿæˆ
```

### ã‚±ãƒ¼ã‚¹2: æƒ…å ±ä¸è¶³ã®å ´åˆ

**ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦æ•™ãˆã¦ã€

**Agentã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹**:
```
1. ğŸ¤” ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼ã€ã§æ¤œç´¢ã—ã¦ã¿ã‚‹
2. ğŸ”§ search_discord_messages(query="ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼", time_range="1d")
3. ğŸ‘€ çµæœãŒ0ä»¶...
4. ğŸ¤” æ™‚é–“ç¯„å›²ã‚’åºƒã’ã¦ã¿ã‚ˆã†
5. ğŸ”§ search_discord_messages(query="ãƒ‡ãƒ—ãƒ­ã‚¤", time_range="1w")
6. ğŸ‘€ 3ä»¶è¦‹ã¤ã‹ã£ãŸ
7. ğŸ¤” ã§ã‚‚ã€Œã‚¨ãƒ©ãƒ¼ã€ã«ã¤ã„ã¦å…·ä½“çš„ãªæƒ…å ±ãŒãªã„
8. âœ… ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã«é–¢ã™ã‚‹è­°è«–ã¯è¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒã€ã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦ã¯
      å…·ä½“çš„ã«ã©ã‚“ãªå•é¡ŒãŒèµ·ãã¦ã„ã‚‹ã‹æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹?ã€
```

## æ³¨æ„ç‚¹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### å®‰å…¨è£…ç½®
- **æœ€å¤§åå¾©å›æ•°**: 10-15å›(ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢)
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 60-90ç§’
- **ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™**: 50,000ãƒˆãƒ¼ã‚¯ãƒ³/ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: Discord APIã€Anthropic APIã®åˆ¶é™ã‚’éµå®ˆ

### ãƒ„ãƒ¼ãƒ«è¨­è¨ˆ
- **å˜ä¸€è²¬ä»»**: 1ãƒ„ãƒ¼ãƒ« = 1æ©Ÿèƒ½
- **æ˜ç¢ºãªèª¬æ˜**: ClaudeãŒåˆ¤æ–­ã§ãã‚‹è©³ç´°ãªdescription
- **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: å¤±æ•—æ™‚ã‚‚Claudeã«è¿”ã—ã¦å†è©¦è¡Œå¯èƒ½ã«
- **å†ªç­‰æ€§**: åŒã˜å‘¼ã³å‡ºã—ã§åŒã˜çµæœ
- **é«˜é€ŸåŒ–**: ã§ãã‚‹ã ã‘è»½é‡ã«

### ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†
- **ã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦**: ç›´è¿‘2-3ã‚¿ãƒ¼ãƒ³ã®ã¿ä¿æŒ
- **è¦ç´„**: é•·ã„ä¼šè©±ã¯å®šæœŸçš„ã«è¦ç´„
- **é‡è¦æƒ…å ±**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€åˆã®è³ªå•ã¯å¸¸ã«ä¿æŒ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“
- **ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º**: ã€Œè€ƒãˆä¸­ã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆé€šçŸ¥**: å‡¦ç†ãŒé•·å¼•ãå ´åˆã¯ä¸­é–“å ±å‘Š
- **ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã¸é™æ ¼

## å‚è€ƒè³‡æ–™

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Anthropic Tool Use Documentation](https://docs.anthropic.com/claude/docs/tool-use)
- [Building agents with the Claude Agent SDK](https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk)
- [Model Context Protocol (MCP)](https://modelcontextprotocol.io/)

### Agent SDK
- [Claude Agent SDK (Python)](https://github.com/anthropics/claude-agent-sdk-python)
- [Claude Agent SDK (TypeScript)](https://github.com/anthropics/claude-agent-sdk-typescript)
- [Claude Code SDK Demos](https://github.com/anthropics/claude-code-sdk-demos)

### ãã®ä»–ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- [Claude Code GitHub](https://github.com/anthropics/claude-code)
- [LangChain Agent Documentation](https://python.langchain.com/docs/modules/agents/)

## ã¾ã¨ã‚

### 3ã¤ã®é¸æŠè‚¢ã®æ¯”è¼ƒ

| é …ç›® | é¸æŠè‚¢1: CLIåŒ…ã‚€ | é¸æŠè‚¢2: Agent SDK | é¸æŠè‚¢3: è‡ªå‰å®Ÿè£… |
|-----|----------------|-------------------|-----------------|
| è¨€èª | Ruby(subprocess) | Python/TypeScript | Ruby |
| Agent loop | CLIå†…éƒ¨ | SDKå†…éƒ¨ | è‡ªåˆ†ã§å®Ÿè£… |
| ãƒ„ãƒ¼ãƒ«è¿½åŠ  | å›°é›£ | Python/TSé–¢æ•° | Ruby class |
| Railsçµ±åˆ | è¤‡é›‘ | è¤‡é›‘(å¤šè¨€èª) | ãƒã‚¤ãƒ†ã‚£ãƒ– |
| ä¿å®ˆæ€§ | ä½ | ä¸­ | é«˜ |
| å­¦ç¿’æ›²ç·š | ä½ | ä¸­ | é«˜ |
| ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º | ä½ | ä¸­ | é«˜ |
| å…¬å¼ã‚µãƒãƒ¼ãƒˆ | ãªã— | ã‚ã‚Š | ãªã— |
| æ¨å¥¨åº¦ | âŒ | ğŸ¤” | â­ï¸ |

### ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®çµè«–

**é¸æŠè‚¢3(è‡ªå‰å®Ÿè£…)ã‚’æ¨å¥¨**ã™ã‚‹ç†ç”±:

âœ… **åŒã˜æŠ€è¡“**: LLM (Claude Sonnet 4.5) / API (Anthropic Tool Use) / ãƒ‘ã‚¿ãƒ¼ãƒ³ (Agentic Loop)
âœ… **Railsçµ±åˆ**: ãƒã‚¤ãƒ†ã‚£ãƒ–Rubyå®Ÿè£…ã§ä¿å®ˆæ€§ãŒé«˜ã„
âœ… **Discordæœ€é©åŒ–**: Discordå°‚ç”¨ãƒ„ãƒ¼ãƒ«ã‚’è‡ªç”±ã«è¨­è¨ˆå¯èƒ½
âœ… **å­¦ç¿’æ©Ÿä¼š**: Agentå®Ÿè£…ã®æ·±ã„ç†è§£ãŒå¾—ã‚‰ã‚Œã‚‹
âœ… **ã‚·ãƒ³ãƒ—ãƒ«**: Agentãƒ«ãƒ¼ãƒ—è‡ªä½“ã¯100è¡Œç¨‹åº¦

é›£ã—ã„ã®ã¯ãƒ„ãƒ¼ãƒ«è¨­è¨ˆã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´ã§ã€**ã“ã‚Œã¯ã©ã®é¸æŠè‚¢ã§ã‚‚å¿…è¦ãªä½œæ¥­**ã€‚

### Agent SDKã‚’æ¤œè¨ã™ã¹ãã‚±ãƒ¼ã‚¹

ä»¥ä¸‹ã®å ´åˆã¯é¸æŠè‚¢2(Agent SDK)ã‚‚æ¤œè¨ä¾¡å€¤ã‚ã‚Š:

- Python/TypeScriptã®å°å…¥ã«æŠµæŠ—ãŒãªã„
- å¤§è¦æ¨¡ã§è¤‡é›‘ãªAgentæ©Ÿèƒ½ãŒå¿…è¦
- å…¬å¼ã‚µãƒãƒ¼ãƒˆã¨ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒé‡è¦
- Claude Codeã®é«˜åº¦ãªæ©Ÿèƒ½(ã‚³ãƒ¼ãƒ‰ç”Ÿæˆç­‰)ã‚’æ´»ç”¨ã—ãŸã„
- ãƒãƒ¼ãƒ ã«Python/TypeScriptã®çµŒé¨“è€…ãŒã„ã‚‹
