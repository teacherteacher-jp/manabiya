<% content_for(:title) { @intake_session.intake.title } %>

<div class="max-w-3xl mx-auto" data-controller="intake-chat" data-intake-chat-session-id-value="<%= @intake_session.id %>" data-intake-chat-status-value="<%= @intake_session.status %>">
  <h2 class="text-xl md:text-2xl font-bold mb-4"><%= @intake_session.intake.title %></h2>

  <div id="messages"
       data-intake-chat-target="messages"
       class="bg-white rounded-lg shadow-md p-4 mb-4 h-96 overflow-y-auto space-y-4">
    <% if @intake_session.intake_messages.any? %>
      <% @intake_session.intake_messages.order(:created_at).each do |msg| %>
        <div class="<%= msg.user? ? 'bg-indigo-50' : 'bg-gray-50' %> rounded-lg p-3">
          <div class="text-xs font-bold mb-1 <%= msg.user? ? 'text-indigo-600' : 'text-gray-600' %>">
            <%= msg.user? ? 'あなた' : 'アシスタント' %>
          </div>
          <div class="whitespace-pre-wrap"><%= msg.content %></div>
        </div>
      <% end %>
    <% else %>
      <p class="text-gray-400 text-center" data-intake-chat-target="placeholder">
        読み込み中...
      </p>
    <% end %>
  </div>

  <% if @intake_session.in_progress? %>
    <form data-action="submit->intake-chat#send" class="flex gap-2">
      <textarea
        data-intake-chat-target="input"
        rows="2"
        class="flex-1 border border-gray-300 rounded-lg p-3 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500"
        placeholder="メッセージを入力..."
      ></textarea>
      <button
        type="submit"
        data-intake-chat-target="submit"
        class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 text-sm rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
      >
        送信
      </button>
    </form>
  <% else %>
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
      <p class="text-green-700 font-bold mb-2">問診が完了しました</p>
      <% if @intake_session.intake_report %>
        <%= link_to "レポートを見る", intake_report_path(@intake_session.intake_report), class: "text-green-600 hover:text-green-800 underline" %>
      <% end %>
    </div>
  <% end %>

  <% if @intake_session.intake_responses.any? %>
    <details class="mt-6" open>
      <summary class="text-gray-600 cursor-pointer hover:text-gray-800 font-bold">
        記録済みの回答（<%= @intake_session.intake_responses.count %>件）
      </summary>
      <div class="mt-2 bg-gray-50 rounded-lg p-4 space-y-3">
        <% @intake_session.intake_responses.includes(:intake_item).each do |response| %>
          <div class="border-b border-gray-200 pb-2 last:border-b-0 last:pb-0">
            <div class="text-sm font-bold text-gray-700"><%= response.intake_item.name %></div>
            <div class="text-gray-600 whitespace-pre-wrap"><%= response.content %></div>
          </div>
        <% end %>
      </div>
    </details>
  <% end %>
</div>
